# 城堡建筑系统 功能设计文档示例

> 本文档为建筑功能类型的参考示例，展示建筑功能特有的章节和填写方式。

---

## 一、设计目的

### 1.1 功能定位

城堡建筑系统是游戏核心养成系统之一，为玩家提供：
- 资源产出（如金矿、粮仓）
- 战斗力提升（如兵营、防御塔）
- 功能解锁（如研究所、工坊）

通过建筑的建造和升级，玩家提升自身实力，推进游戏进程。建筑系统也是游戏付费转化的重要环节（加速道具、钻石加速）。

### 1.2 期望体验

- **成长可见**：建筑外观随等级变化，玩家能直观感受到成长
- **策略选择**：多种建筑类型，玩家需要规划建造优先级
- **即时满足**：低等级建筑快速完成，高等级建筑可付费加速
- **目标明确**：清晰的升级条件和收益，玩家有明确的追求目标

---

## 二、功能概述

### 2.1 背景概述

玩家作为领主，需要在领地上建造和升级各类建筑，发展自己的城堡。每个建筑都有独特的功能，共同构成完整的城堡生态系统。

### 2.2 功能简介

**核心玩法**：

玩家在城堡内选择空地或已有建筑，进行建造或升级操作。建造/升级需要消耗特定资源和时间。玩家可以使用加速道具或钻石立即完成建造。建筑升级后解锁新功能或提升产出效率。

**主要特点**：

1. **分类明确**：资源建筑、军事建筑、功能建筑三大类
2. **等级联动**：多数建筑需要主堡达到特定等级才能升级
3. **时间养成**：高等级建筑需要数小时甚至数天完成
4. **加速机制**：提供多种加速方式，平衡免费和付费玩家体验
5. **视觉反馈**：建筑外观随等级变化，建造过程有明显表现

**玩家操作**：

1. 点击城堡内的空地或已有建筑
2. 查看建筑信息和升级条件
3. 点击建造/升级按钮
4. 等待建造完成或使用加速
5. 建造完成后点击建筑使用功能

### 2.3 结构划分

```
城堡建筑系统
├── 核心建筑
│   └── 主堡（城堡核心，限制其他建筑等级上限）
├── 资源建筑
│   ├── 金矿（产出金币）
│   ├── 粮仓（产出粮食）
│   ├── 木材厂（产出木材）
│   └── 仓库（增加资源存储上限）
├── 军事建筑
│   ├── 兵营（训练士兵）
│   ├── 防御塔（城防）
│   ├── 城墙（防御）
│   └── 训练场（提升兵种属性）
└── 功能建筑
    ├── 研究所（科技研究）
    ├── 工坊（装备打造）
    ├── 市场（资源交易）
    └── 医院（治疗伤兵）
```

---

## 三、规则说明

### 3.1 建筑初始状态

**游戏开始时**，玩家城堡内已有以下建筑：
- 主堡（等级1）
- 金矿×1（等级1）
- 粮仓×1（等级1）
- 兵营×1（等级1）

其他建筑需要玩家自行建造或通过主堡升级解锁。

### 3.2 建筑解锁条件

| 建筑名称 | 解锁条件 | 说明 |
|----------|----------|------|
| 主堡 | 初始拥有 | 城堡核心，不可拆除 |
| 金矿 | 初始拥有，主堡≥2可建第2个 | 最多可建3个 |
| 粮仓 | 初始拥有，主堡≥2可建第2个 | 最多可建3个 |
| 木材厂 | 主堡≥3 | 最多可建2个 |
| 兵营 | 初始拥有，主堡≥5可建第2个 | 最多可建4个 |
| 研究所 | 主堡≥4 | 仅可建1个 |
| 防御塔 | 主堡≥6 | 最多可建5个 |
| 工坊 | 主堡≥7 | 仅可建1个 |
| 市场 | 主堡≥8 | 仅可建1个 |
| 医院 | 主堡≥10 | 仅可建1个 |

### 3.3 升级规则

#### 3.3.1 升级条件

建筑升级需要同时满足以下条件：

| 条件类型 | 说明 |
|----------|------|
| 前置建筑等级 | 主堡等级≥目标等级（主堡本身无此限制） |
| 资源消耗 | 拥有足够的金币、粮食、木材 |
| 建造队列 | 当前建造队列有空位（默认1个，VIP可增加） |
| 建筑数量 | 该类型建筑未达到数量上限 |

**示例**：
- 升级金矿到等级5，需要主堡≥5，消耗金币10000、木材5000，耗时2小时
- 主堡升级到等级10，无前置等级要求，消耗金币50000、粮食30000、木材40000，耗时24小时

#### 3.3.2 升级流程

1. **检查条件**：系统检查是否满足所有升级条件
2. **扣除资源**：满足条件后扣除所需资源
3. **开始建造**：建筑进入建造状态，显示建造动画和倒计时
4. **等待完成**：倒计时结束或使用加速后建造完成
5. **升级生效**：建筑等级提升，外观变化，功能增强

#### 3.3.3 升级表现

**建造中状态**：
- 建筑上方显示建造进度条和剩余时间
- 建筑外观显示脚手架或工人动画
- 该建筑功能正常使用（不影响产出和使用）

**完成时表现**：
- 播放升级完成特效（光效、音效）
- 建筑外观切换到新等级外观
- 弹出提示："XXX建筑升级到LvX完成"

### 3.4 加速规则

建筑建造/升级过程支持多种加速方式：

#### 3.4.1 道具加速

| 道具名称 | 加速时长 | 获取方式 |
|--|----------|----------|
| 加速道具（1分钟） | 1分钟 | 任务奖励、活动奖励 |
| 加速道具（10分钟） | 10分钟 | 商店购买、VIP赠送 |
| 加速道具（1小时） | 1小时 | 高级礼包、活动奖励 |
| 加速道具（8小时） | 8小时 | 充值奖励 |

**使用规则**：
- 可连续使用多个加速道具
- 加速时间可以超过剩余时间，超出部分浪费
- 剩余时间≤5分钟时，可免费完成

#### 3.4.2 钻石加速

**计费规则**：
- 剩余时间≤5分钟：免费完成
- 剩余时间5分钟-1小时：每10分钟消耗10钻石
- 剩余时间1小时-12小时：每小时消耗50钻石
- 剩余时间12小时以上：每小时消耗100钻石

**示例计算**：
- 剩余时间3分钟：免费
- 剩余时间30分钟：10×3 = 30钻石
- 剩余时间5小时：50×5 = 250钻石
- 剩余时间25小时：(100×13 + 50×12) = 1900钻石

**策略提示**：
- 玩家可以先用加速道具减少剩余时间，再用钻石加速节省费用
- VIP玩家享受钻石加速折扣（VIP3享受9折，VIP5享受8折）

### 3.5 队列管理

**建造队列**：
- 普通玩家默认1个建造队列，同时只能建造1个建筑
- VIP3及以上玩家拥有2个建造队列，可同时建造2个建筑
- 第2队列可通过钻石临时解锁（500钻石/24小时）

**队列优先级**：
- 主堡升级优先级最高，会占用队列1
- 玩家可以手动拖动队列顺序调整优先级

### 3.6 特殊处理

| 特殊情况 | 处理方式 |
|----------|----------|
| 建造中资源被掠夺至不足 | 不影响当前建造，下次升级时重新检查资源 |
| 建造中主堡被降级 | 当前建造继续，完成后该建筑等级可能高于主堡等级 |
| 使用加速时网络断线 | 加速道具/钻石不扣除，重连后可重新使用 |
| 建造完成时背包已满 | 不影响建造完成，奖励（如解锁奖励）发送邮件 |
| 玩家在建造中删除游戏重装 | 建造进度保存在服务器，重新登录后恢复 |
| 多个相同建筑同时升级 | 允许，每个建筑独立计算 |
| 升级到上限等级 | 升级按钮显示"已满级"，不可再升级 |

### 3.7 建筑产出规则（资源建筑）

**金矿产出规则**：
- 基础产量：100金币/小时（等级1）
- 成长公式：基础产量 × (1 + 等级 × 0.5)
- 示例：等级5金矿产量 = 100 × (1 + 5 × 0.5) = 350金币/小时
- 存储上限：24小时产量，超过后停止生产（需要手动收取）

**离线产出**：
- 玩家离线期间，资源建筑继续生产
- 离线产出最多累积48小时
- 超过48小时的部分不再累积

---

## 四、策划需求

### 4.1 数值需求

**建筑等级上限**：

| 建筑类型 | 最大等级 |
|----------|----------|
| 主堡 | 30 |
| 资源建筑 | 25 |
| 军事建筑 | 25 |
| 功能建筑 | 20 |

**建造时间参考**：

| 等级范围 | 建造时长 |
|----------|----------|
| 1-5 | 1分钟-30分钟 |
| 6-10 | 30分钟-4小时 |
| 11-15 | 4小时-12小时 |
| 16-20 | 12小时-2天 |
| 21-25 | 2天-5天 |
| 26-30 | 5天-7天 |

**免费加速时间**：剩余时间≤5分钟可免费完成

**VIP建造队列**：
- VIP0-2：1个队列
- VIP3-9：2个队列
- VIP10：3个队列

### 4.2 系统需求

**依赖系统**：
- **资源系统**：管理金币、粮食、木材等资源的生产和消耗
- **背包系统**：存储加速道具
- **VIP系统**：提供VIP建造队列和加速折扣
- **任务系统**：建筑升级可触发任务进度
- **成就系统**：建筑升级可触发成就
- **时间系统**：处理离线产出和建造倒计时

**接口需求**：
- `GetBuildingInfo(buildingId)`：获取建筑信息
- `UpgradeBuilding(buildingId)`：升级建筑
- `SpeedUpBuilding(buildingId, speedType, itemId)`：加速建筑
- `CollectResource(buildingId)`：收取资源产出
- `GetBuildQueue(playerId)`：获取玩家建造队列状态

### 4.3 配置表需求

**新建表：building_config**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| building_id | int | 建筑ID |
| building_name | string | 建筑名称 |
| building_type | enum | 建筑类型：core/resource/military/function |
| max_count | int | 最大建造数量 |
| max_level | int | 最大等级 |
| unlock_condition | json | 解锁条件（主堡等级等） |

**新建表：building_level_config**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| building_id | int | 建筑ID |
| level | int | 等级 |
| cost_gold | int | 金币消耗 |
| cost_food | int | 粮食消耗 |
| cost_wood | int | 木材消耗 |
| build_time | int | 建造时长（秒） |
| require_castle_level | int | 所需主堡等级 |
| output_value | int | 产出值（仅资源建筑） |
| attribute_bonus | json | 属性加成（仅功能建筑） |

**修改表：player_building**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| player_id | bigint | 玩家ID |
| building_instance_id | bigint | 建筑实例ID |
| building_id | int | 建筑配置ID |
| level | int | 当前等级 |
| position_x | int | 城堡内位置X |
| position_y | int | 城堡内位置Y |
| status | enum | 状态：normal/building/upgrading |
| build_start_time | datetime | 建造开始时间 |
| build_end_time | datetime | 建造结束时间 |
| last_collect_time | datetime | 上次收取时间（资源建筑） |

---

## 附录：参考信息

**文档版本**：v1.0  
**创建时间**：2026-01-28  
**最后更新**：2026-01-28  

**说明**：
- 本文档为建筑功能类型的示例，重点展示了建筑特有的升级、加速、队列管理等规则
- 实际项目中应根据建筑数量和复杂度调整章节详细程度
- 建筑类功能需要特别注意数值平衡和付费点设计
